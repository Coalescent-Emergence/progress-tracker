name: Deploy MVP Tracker to GitHub Pages

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'If true, list files only and do not commit (true|false)'
        required: false
        default: 'true'

  # Runs on a schedule (daily at midnight UTC)
  schedule:
    - cron: '0 0 * * *'

  # Allows triggering from external repositories via repository_dispatch
  repository_dispatch:
    types: [deploy]

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write  # Allow sync job to commit and push changes
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build artifacts and deploy to GitHub Pages
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate issues JSON for tracker
        env:
          OWNER: Coalescent-Emergence
          REPO: Kerrigan
          TOKEN: ${{ secrets.KERRIGAN_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          # Ensure script is executable
          chmod +x ./scripts/generate_issues_json.sh
          ./scripts/generate_issues_json.sh

      - name: Apply post-sync fixes to mvp-tracker.html
        run: |
          set -euo pipefail
          TRACKER_FILE="docs/mvp-tracker.html"
          
          if [ ! -f "$TRACKER_FILE" ]; then
            echo "Warning: $TRACKER_FILE not found, skipping post-sync fixes"
            exit 0
          fi
          
          # Check if normalizeLabels function exists
          if grep -q "function normalizeLabels" "$TRACKER_FILE"; then
            echo "✓ normalizeLabels function already exists"
          else
            echo "⚠ normalizeLabels function missing, applying fix..."
            
            # Find the categorizeIssue function and add normalizeLabels before it
            if grep -q "function categorizeIssue" "$TRACKER_FILE"; then
              # Create a temporary file with the fix
              awk "/function categorizeIssue/ && !done {
                  print \"        function normalizeLabels(issue) {\"
                  print \"            return issue.labels.map(l => typeof l === 'string' ? l.toLowerCase() : l.name.toLowerCase());\"
                  print \"        }\"
                  print \"        \"
                  done = 1
                }
                { print }" "$TRACKER_FILE" > "$TRACKER_FILE.tmp"
              mv "$TRACKER_FILE.tmp" "$TRACKER_FILE"
              
              # Replace all instances of direct label mapping with normalizeLabels
              sed -i 's/const labels = issue\.labels\.map(l => l\.name\.toLowerCase());/const labels = normalizeLabels(issue);/g' "$TRACKER_FILE"
              
              echo "✓ Applied normalizeLabels fix"
            else
              echo "⚠ Could not find categorizeIssue function, manual fix may be needed"
            fi
          fi

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Sync MVP tracker from source repository"
            git push
          fi

  # Build and deploy to GitHub Pages
  deploy:
    needs: sync
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout latest changes
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Pull latest commit from sync
        run: |
          git fetch origin ${{ github.ref_name }}
          if [ "$(git rev-parse HEAD)" != "$(git rev-parse origin/${{ github.ref_name }})" ]; then
            git pull --ff-only origin ${{ github.ref_name }}
          else
            echo "Already up to date with remote"
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Upload docs directory
          path: 'docs'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
