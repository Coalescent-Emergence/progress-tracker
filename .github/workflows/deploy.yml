name: Deploy MVP Tracker to GitHub Pages

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'If true, list files only and do not commit (true|false)'
        required: false
        default: 'true'

  # Runs on a schedule (daily at midnight UTC)
  schedule:
    - cron: '0 0 * * *'

  # Allows triggering from external repositories via repository_dispatch
  repository_dispatch:
    types: [deploy]

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write  # Allow sync job to commit and push changes
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Sync files from source repository
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout Kerrigan (sparse)
        uses: actions/checkout@v4
        with:
          repository: Coalescent-Emergence/Kerrigan
          token: ${{ secrets.KERRIGAN_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
          ref: main
          persist-credentials: false
          path: source-repo
          fetch-depth: 1
          sparse-checkout: |
            docs/mvp-tracker.html
            docs/index.html
            docs/_config.yml
            MVP_STATUS.md
            docs/TRACKER_SETUP.md
            docs/README.md
            docs/mvp.md
            GITHUB_PAGES_SETUP.md
            README.md

      - name: Validate and copy static files
        run: |
          set -euo pipefail
          SRC=source-repo
          mkdir -p docs
          # Allowed top-level path patterns and extensions
          ALLOWED_PATHS=("docs/" "MVP_STATUS.md" "GITHUB_PAGES_SETUP.md" "README.md")
          ALLOWED_EXTS="html css js svg png jpg jpeg webp woff2 ico json md"

          is_allowed_path() {
            local rel="$1"
            for p in "${ALLOWED_PATHS[@]}"; do
              case "$rel" in
                "$p"* ) return 0 ;;
              esac
            done
            return 1
          }

          for f in $(find "$SRC" -type f); do
            rel="${f#$SRC/}"
            ext="${f##*.}"
            # normalize extension to lower
            ext="$(echo "$ext" | tr '[:upper:]' '[:lower:]')"
            case " $ALLOWED_EXTS " in
              *" $ext "*) ;;
              *) echo "Skipping disallowed extension: $rel"; continue ;;
            esac
            if ! is_allowed_path "$rel"; then
              echo "Skipping file outside allowed paths: $rel"
              continue
            fi
            echo "Copying $rel"
            mkdir -p "$(dirname "docs/$rel")"
            cp "$f" "docs/$rel"
          done

          # If no index found, create a small placeholder
          if [ ! -f "docs/index.html" ] && [ ! -f "docs/mvp-tracker.html" ]; then
            echo "Warning: No MVP tracker files found. Creating placeholder."
            echo '<!DOCTYPE html><html><head><title>MVP Tracker</title></head><body><h1>MVP Tracker</h1><p>Awaiting content sync...</p></body></html>' > docs/index.html
          fi

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Sync MVP tracker from source repository"
            git push
          fi

  # Build and deploy to GitHub Pages
  deploy:
    needs: sync
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout latest changes
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Pull latest commit from sync
        run: |
          git fetch origin ${{ github.ref_name }}
          if [ "$(git rev-parse HEAD)" != "$(git rev-parse origin/${{ github.ref_name }})" ]; then
            git pull --ff-only origin ${{ github.ref_name }}
          else
            echo "Already up to date with remote"
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Upload docs directory
          path: 'docs'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
